<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Daftar Barang</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #fff;
    }
    h1 {
      color: #222;
    }
    input[type="text"] {
      padding: 5px;
      font-size: 14px;
    }
    button {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid black;
      background: navy;
      color: white;
      cursor: pointer;
      margin-left: 5px;
    }
    button:hover {
      opacity: 0.9;
    }
    table {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #eee;
    }
    #pagination {
      margin-top: 15px;
    }
    #pageInfo {
      margin: 0 10px;
    }
  </style>
</head>
<body>

  <h1>Daftar Barang</h1>

  <input type="text" id="searchBox" placeholder="Cari produk..." />
  <button onclick="searchProducts()">Cari</button>

  <table id="resultTable">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama Produk</th>
        <th>Harga</th>
        <th>Stok</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="pagination">
    <button onclick="changePage(-1)">Prev</button>
    <span id="pageInfo">Page 1 of 1</span>
    <button onclick="changePage(1)">Next</button>
  </div>

  <script>
    let db;
    let currentPage = 1;
    const pageSize = 15;
    let currentKeyword = "";
    let totalPages = 1;

    // load DB
    initSqlJs({ locateFile: file => "https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.wasm" })
      .then(SQL => fetch("data.db")
        .then(res => res.arrayBuffer())
        .then(buf => {
          db = new SQL.Database(new Uint8Array(buf));
          updateTotalPages();
          displayProducts();
        })
      );

    function updateTotalPages() {
      let countQuery = "SELECT COUNT(*) as cnt FROM Product LEFT JOIN Stock ON Product.Id = Stock.ProductId";
      let params = {};
      if (currentKeyword) {
        countQuery += " WHERE Product.Name LIKE $search";
        params.$search = "%" + currentKeyword + "%";
      }

      const stmt = db.prepare(countQuery);
      stmt.bind(params);
      stmt.step();
      const row = stmt.getAsObject();
      totalPages = Math.max(1, Math.ceil(row.cnt / pageSize));
      stmt.free();
    }

    function displayProducts(keyword = currentKeyword) {
      currentKeyword = keyword;
      updateTotalPages(); // refresh total pages with keyword filter

      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";

      let query = `
        SELECT Product.Id, Product.Name, Product.Price, Stock.Quantity
        FROM Product
        LEFT JOIN Stock ON Product.Id = Stock.ProductId
      `;
      let params = {};

      if (keyword) {
        query += " WHERE Product.Name LIKE $search";
        params.$search = "%" + keyword + "%";
      }

      query += " LIMIT $limit OFFSET $offset";
      params.$limit = pageSize;
      params.$offset = (currentPage - 1) * pageSize;

      try {
        const stmt = db.prepare(query);
        stmt.bind(params);

        while (stmt.step()) {
          const row = stmt.getAsObject();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.Id}</td>
            <td>${row.Name}</td>
            <td>${row.Price}</td>
            <td>${row.Quantity ?? 0}</td>
          `;
          tbody.appendChild(tr);
        }
        stmt.free();

        if (tbody.children.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4">Tidak ada hasil ditemukan</td></tr>`;
        }

        document.getElementById("pageInfo").innerText = "Page " + currentPage + " of " + totalPages;

      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="4">Error: ${err.message}</td></tr>`;
      }
    }

    function searchProducts() {
      currentPage = 1;
      const keyword = document.getElementById("searchBox").value.trim();
      displayProducts(keyword);
    }

    function changePage(direction) {
      if (direction === -1 && currentPage > 1) {
        currentPage--;
        displayProducts();
      } else if (direction === 1 && currentPage < totalPages) {
        currentPage++;
        displayProducts();
      }
    }
  </script>
</body>
</html>
