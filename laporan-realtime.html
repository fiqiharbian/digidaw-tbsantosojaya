<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Transaksi Hari Ini</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">Transaksi Hari Ini</h1>
    <p id="subtitle" class="text-gray-600 mb-6"></p>

    <!-- Table transaksi -->
    <div class="overflow-x-auto bg-white rounded-xl shadow p-4 mb-6">
      <table class="min-w-full border-collapse">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="p-2 border-b">No. Nota</th>
            <th class="p-2 border-b">Total Belanja</th>
            <th class="p-2 border-b">Metode</th>
            <th class="p-2 border-b">Tipe Transaksi</th>
            <th class="p-2 border-b">Waktu</th>
          </tr>
        </thead>
        <tbody id="transactions"></tbody>
      </table>
    </div>

    <!-- Ringkasan -->
    <div class="overflow-x-auto bg-white rounded-xl shadow p-4">
      <h2 class="text-xl font-semibold mb-4">Ringkasan Transaksi</h2>
      <table class="min-w-full border-collapse">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="p-2 border-b">Metode</th>
            <th class="p-2 border-b">Tipe Transaksi</th>
            <th class="p-2 border-b">Total Transaksi</th>
            <th class="p-2 border-b">Nominal (Rp)</th>
          </tr>
        </thead>
        <tbody id="summary"></tbody>
      </table>
    </div>
  </div>

  <script>
    const DateTime = luxon.DateTime;

    // Subtitle: current Jakarta time
    function updateTime() {
      const now = DateTime.now().setZone("Asia/Jakarta");
      document.getElementById("subtitle").textContent =
        now.toFormat("cccc, dd LLL yyyy HH:mm:ss");
    }
    setInterval(updateTime, 1000);
    updateTime();

    let payments = [];
    let refunds = [];
    let paymentTypes = [];
    let paymentTypesMap = {};

    async function loadData() {
      try {
        const res = await axios.get("Transactions.json");
        const data = res.data;

        payments = (data.Payment || []).map(p => ({...p, Type:"Pembelian"}));
        refunds = (data.Refund || []).map(r => ({
          ...r,
          Type: "Refund"
        }));
        paymentTypes = data.PaymentType || [];
        paymentTypes.forEach(pt => paymentTypesMap[pt.Id] = pt.Name);

        renderToday();

      } catch(err) {
        console.error("Error loading Transactions.json", err);
      }
    }

    function renderToday() {
      const allTransactions = [...payments, ...refunds];
      const todayStr = DateTime.now().setZone("Asia/Jakarta").toFormat("yyyy-LL-dd");

      const todayTx = allTransactions.filter(t => {
        const dt = DateTime.fromISO(t.DateCreated, { zone: "Asia/Jakarta" });
        return dt.toFormat("yyyy-LL-dd") === todayStr;
      });

      renderTable(todayTx);
      renderSummary(todayTx);
    }

    function renderTable(transactions) {
      const tbody = document.getElementById("transactions");
      tbody.innerHTML = "";
      let counter = 1;

      transactions.sort((a,b) => new Date(a.DateCreated) - new Date(b.DateCreated));

      transactions.forEach(t => {
        const dt = DateTime.fromISO(t.DateCreated, { zone: "Asia/Jakarta" });
        const jam = dt.isValid ? dt.toFormat("HH:mm") : "-";

        const tr = document.createElement("tr");

        if(t.Type === "Refund"){
          tr.className = "text-red-600 font-semibold";
        }

        tr.innerHTML = `
          <td class="p-2 border-b">${t.Type === "Pembelian" ? counter++ : "-"}</td>
          <td class="p-2 border-b">Rp ${Number(t.Amount).toLocaleString("id-ID")}</td>
          <td class="p-2 border-b">${t.PaymentTypeId ? paymentTypesMap[t.PaymentTypeId] : "-"}</td>
          <td class="p-2 border-b">${t.Type}</td>
          <td class="p-2 border-b">${jam}</td>
        `;

        tbody.appendChild(tr);
      });

      if(transactions.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="p-2 border-b text-center">Tidak ada transaksi hari ini</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderSummary(transactions) {
      const summaryData = {};

      transactions.forEach(t => {
        const method = t.PaymentTypeId ? paymentTypesMap[t.PaymentTypeId] : "-";
        const type = t.Type;
        const amt = Number(t.Amount) || 0;

        if(!summaryData[method]) summaryData[method] = {};
        if(!summaryData[method][type]) summaryData[method][type] = { count:0, total:0 };

        summaryData[method][type].count++;
        summaryData[method][type].total += amt;
      });

      const sumBody = document.getElementById("summary");
      sumBody.innerHTML = "";

      Object.keys(summaryData).forEach(method => {
        Object.keys(summaryData[method]).forEach(type => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="p-2 border-b font-semibold">${method}</td>
            <td class="p-2 border-b">${type}</td>
            <td class="p-2 border-b">${summaryData[method][type].count}</td>
            <td class="p-2 border-b">Rp ${summaryData[method][type].total.toLocaleString("id-ID")}</td>
          `;
          if(type === "Refund") row.className = "text-red-600 font-semibold";
          sumBody.appendChild(row);
        });
      });
    }

    loadData();
    setInterval(loadData, 60000); // refresh every 60s
  </script>
</body>
</html>
