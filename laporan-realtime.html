<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Transaksi Hari Ini</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">Transaksi Hari Ini</h1>
    <p id="subtitle" class="text-gray-600 mb-6"></p>

    <div class="overflow-x-auto bg-white rounded-xl shadow p-4">
      <table class="min-w-full border-collapse">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="p-2 border-b">No. Nota</th>
            <th class="p-2 border-b">Total Belanja</th>
            <th class="p-2 border-b">Metode / Type</th>
            <th class="p-2 border-b">Waktu</th>
          </tr>
        </thead>
        <tbody id="transactions"></tbody>
      </table>
    </div>

    <!-- Summary Table -->
    <div class="overflow-x-auto bg-white rounded-xl shadow p-4 mt-6">
      <table class="min-w-full border-collapse">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="p-2 border-b">Metode / Type</th>
            <th class="p-2 border-b">Total Transaksi</th>
          </tr>
        </thead>
        <tbody id="summary"></tbody>
      </table>
    </div>
  </div>

  <script>
    const DateTime = luxon.DateTime;

    // Subtitle: current Jakarta time
    function updateTime() {
      const now = DateTime.now().setZone("Asia/Jakarta");
      document.getElementById("subtitle").textContent =
        now.toFormat("cccc, dd LLL yyyy HH:mm:ss");
    }
    setInterval(updateTime, 1000);
    updateTime();

    // Fix parsing of DateCreated
    function parseDateTime(dateStr) {
      if (!dateStr) return null;
      let iso = dateStr.replace(" ", "T").replace(/(\.\d{6})\d*/, "$1");
      return DateTime.fromISO(iso, { zone: "Asia/Jakarta" });
    }

    async function loadData() {
      try {
        const res = await axios.get("Transactions.json");
        const data = res.data;

        const payments = (data.Payment || []).map(p => ({...p, Type: "Payment"}));
        const refunds = (data.Refund || []).map(r => ({...r, Type: "Refund", Amount: -r.Amount}));

        const allTransactions = [...payments, ...refunds];

        // Build PaymentTypeId -> Name map
        const typeMap = {};
        (data.PaymentType || []).forEach(pt => typeMap[pt.Id] = pt.Name);

        const tbody = document.getElementById("transactions");
        tbody.innerHTML = "";

        allTransactions.sort((a,b) => new Date(a.DateCreated) - new Date(b.DateCreated));

        let paymentCounter = 1;

        allTransactions.forEach(p => {
          const tr = document.createElement("tr");

          if (p.Type === "Refund") {
            tr.className = "text-red-600"; // Refund font red
            tr.innerHTML = `
              <td class="p-2 border-b">-</td>
              <td class="p-2 border-b">Rp ${Number(p.Amount).toLocaleString("id-ID")}</td>
              <td class="p-2 border-b">Refund</td>
              <td class="p-2 border-b">${parseDateTime(p.DateCreated)?.toFormat("HH:mm") || "-"}</td>
            `;
          } else {
            tr.innerHTML = `
              <td class="p-2 border-b">${paymentCounter++}</td>
              <td class="p-2 border-b">Rp ${Number(p.Amount).toLocaleString("id-ID")}</td>
              <td class="p-2 border-b">${typeMap[p.PaymentTypeId] || "-"}</td>
              <td class="p-2 border-b">${parseDateTime(p.DateCreated)?.toFormat("HH:mm") || "-"}</td>
            `;
          }

          tbody.appendChild(tr);
        });

        // Summary table
        const summary = {};
        allTransactions.forEach(p => {
          const key = p.Type === "Payment" ? (typeMap[p.PaymentTypeId] || "Unknown") : "Refund";
          summary[key] = (summary[key] || 0) + Number(p.Amount);
        });

        const summaryTbody = document.getElementById("summary");
        summaryTbody.innerHTML = "";
        Object.entries(summary).forEach(([k,v]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="p-2 border-b">${k}</td>
            <td class="p-2 border-b">Rp ${v.toLocaleString("id-ID")}</td>
          `;
          summaryTbody.appendChild(tr);
        });

      } catch (err) {
        console.error("Error loading Transactions.json:", err);
      }
    }

    loadData();
    setInterval(loadData, 60000); // refresh setiap 60 detik
  </script>
</body>
</html>
