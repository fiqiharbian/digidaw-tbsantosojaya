<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Laporan Lampau</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Laporan Lampau</h1>

    <!-- Date Selection -->
    <div class="flex flex-col md:flex-row md:space-x-4 mb-6">
      <div>
        <label for="startDate" class="block mb-1 font-semibold">Tanggal Mulai:</label>
        <input type="date" id="startDate" class="px-4 py-2 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label for="endDate" class="block mb-1 font-semibold">Tanggal Akhir (opsional):</label>
        <input type="date" id="endDate" class="px-4 py-2 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="flex items-end mt-4 md:mt-0">
        <button id="filterBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Tampilkan</button>
      </div>
    </div>

    <!-- Table Transaksi -->
    <div class="overflow-x-auto bg-white rounded-xl shadow p-4 mb-6">
      <table class="min-w-full border-collapse">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="p-2 border-b">No. Nota</th>
            <th class="p-2 border-b">Total Belanja</th>
            <th class="p-2 border-b">Metode</th>
            <th class="p-2 border-b">Waktu</th>
          </tr>
        </thead>
        <tbody id="transactions"></tbody>
      </table>
    </div>

    <!-- Ringkasan -->
    <div class="overflow-x-auto bg-white rounded-xl shadow p-4">
      <h2 class="text-xl font-semibold mb-4">Ringkasan Transaksi</h2>
      <table class="min-w-full border-collapse">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="p-2 border-b">Metode</th>
            <th class="p-2 border-b">Total Transaksi</th>
            <th class="p-2 border-b">Nominal (Rp)</th>
          </tr>
        </thead>
        <tbody id="summary"></tbody>
      </table>
    </div>

  </div>

  <script>
    let payments = [];
    let paymentTypes = [];
    let paymentTypesMap = {};

    async function loadData() {
      try {
        const res = await axios.get("Transactions.json");
        const data = res.data;
        payments = data.Payment || [];
        paymentTypes = data.PaymentType || [];

        paymentTypes.forEach(pt => paymentTypesMap[pt.Id] = pt.Name);
      } catch(err) {
        console.error("Error loading Transactions.json", err);
      }
    }

    function filterByDate(start, end=null) {
      return payments.filter(p => {
        const date = new Date(p.DateCreated.replace(" ", "T"));
        const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());

        const startDate = new Date(start);
        startDate.setHours(0,0,0,0);

        if(end){
          const endDate = new Date(end);
          endDate.setHours(23,59,59,999);
          return date >= startDate && date <= endDate;
        } else {
          return dateOnly.getTime() === startDate.getTime();
        }
      });
    }

    function renderTable(filtered) {
      const tbody = document.getElementById("transactions");
      tbody.innerHTML = "";

      filtered.forEach(p => {
        const dateObj = new Date(p.DateCreated.replace(" ", "T"));
        const jam = dateObj.getHours().toString().padStart(2,'0');
        const menit = dateObj.getMinutes().toString().padStart(2,'0');

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2 border-b">${p.Id}</td>
          <td class="p-2 border-b">Rp ${Number(p.Amount).toLocaleString("id-ID")}</td>
          <td class="p-2 border-b">${paymentTypesMap[p.PaymentTypeId] || "-"}</td>
          <td class="p-2 border-b">${jam}:${menit}</td>
        `;
        tbody.appendChild(tr);
      });

      if(filtered.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="p-2 border-b text-center" colspan="4">Tidak ada transaksi pada tanggal ini</td>`;
        tbody.appendChild(tr);
      }

      renderSummary(filtered);
    }

    function renderSummary(filtered) {
      const summaryData = { TOTAL: { count:0, total:0 } };
      filtered.forEach(p => {
        const method = paymentTypesMap[p.PaymentTypeId] || "Lainnya";
        const amt = Number(p.Amount) || 0;
        if(!summaryData[method]) summaryData[method] = { count:0, total:0 };
        summaryData[method].count++;
        summaryData[method].total += amt;

        summaryData["TOTAL"].count++;
        summaryData["TOTAL"].total += amt;
      });

      const sumBody = document.getElementById("summary");
      sumBody.innerHTML = "";

      Object.keys(summaryData).forEach(m => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="p-2 border-b font-semibold">${m}</td>
          <td class="p-2 border-b">${summaryData[m].count}</td>
          <td class="p-2 border-b">Rp ${summaryData[m].total.toLocaleString("id-ID")}</td>
        `;
        sumBody.appendChild(row);
      });
    }

    document.getElementById("filterBtn").addEventListener("click", () => {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      if(!start) return alert("Silakan pilih tanggal mulai!");
      const filtered = filterByDate(start, end || null);
      renderTable(filtered);
    });

    loadData();
  </script>
</body>
</html>
